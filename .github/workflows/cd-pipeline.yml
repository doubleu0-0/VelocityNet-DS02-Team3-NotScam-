name: Continuous Deployment with Prometheus Monitoring

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v4

    # Step 2: Install Prometheus Exporter
    - name: Install Prometheus Exporter
      run: |
        pip install prometheus-client

    # Step 3: Deployment Commands
    - name: Deploy Application
      run: |
        echo "Deploying application..."
        # Add your deployment commands here
        echo "Application deployed successfully."

  monitor:
    runs-on: ubuntu-latest
    needs: deploy  # Run only after the deploy job completes

    steps:
    # Step 1: Test Prometheus Connection
    - name: Test Prometheus Connection
      run: |
        curl -s http://localhost:9090/api/v1/status/buildinfo || echo "Prometheus server not connected"

    # Step 2: Query Prometheus for Metrics
    - name: Query Metrics from Prometheus
      run: |
        # Replace with your Prometheus query
        QUERY_RESULT=$(curl -s "http://localhost:9090/api/v1/query?query=up")
        echo "Prometheus query result: $QUERY_RESULT"

    # Step 3: Validate Metrics
    - name: Validate Application Metrics
      run: |
        echo "Validating Prometheus metrics..."
        # Example of checking if application is running
        APP_UP=$(curl -s "http://localhost:9090/api/v1/query?query=your_app_metric_up")
        if [ "$APP_UP" != "1" ]; then
          echo "Application is not running properly!"
          exit 1
        fi
        echo "Application metrics validated successfully."
